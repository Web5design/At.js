(function(){var a=[].slice;!function(a){return"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery)}(function(b){var c,d,e,f,g,h,i,j,k;return e=function(){function a(a){this.current_flag=null,this.controllers={},this.alias_maps={},this.$inputor=b(a),this.listen()}return a.prototype.controller=function(a){return this.controllers[this.alias_maps[a]||a||this.current_flag]},a.prototype.set_context_for=function(a){return this.current_flag=a,this},a.prototype.reg=function(a,b){var c,d;return c=(d=this.controllers)[a]||(d[a]=new g(this,a)),b.alias&&(this.alias_maps[b.alias]=a),c.init(b),this},a.prototype.listen=function(){return this.$inputor.on("keyup.atwho",function(a){return function(b){return a.on_keyup(b)}}(this)).on("keydown.atwho",function(a){return function(b){return a.on_keydown(b)}}(this)).on("scroll.atwho",function(a){return function(){var b;return null!=(b=a.controller())?b.view.hide():void 0}}(this)).on("blur.atwho",function(a){return function(){var b;return(b=a.controller())?b.view.hide(b.get_opt("display_timeout")):void 0}}(this))},a.prototype.dispatch=function(){return b.map(this.controllers,function(a){return function(b){return b.look_up()?a.set_context_for(b.at):void 0}}(this))},a.prototype.on_keyup=function(a){var c;switch(a.keyCode){case i.ESC:a.preventDefault(),null!=(c=this.controller())&&c.view.hide();break;case i.DOWN:case i.UP:b.noop();break;default:this.dispatch()}},a.prototype.on_keydown=function(a){var c,d;if(c=null!=(d=this.controller())?d.view:void 0,c&&c.visible())switch(a.keyCode){case i.ESC:a.preventDefault(),c.hide();break;case i.UP:a.preventDefault(),c.prev();break;case i.DOWN:a.preventDefault(),c.next();break;case i.TAB:case i.ENTER:if(!c.visible())return;a.preventDefault(),c.choose();break;default:b.noop()}},a}(),g=function(){function d(a,d){this.app=a,this.at=d,this.$inputor=this.app.$inputor,this.oDocument=this.$inputor[0].ownerDocument,this.oWindow=this.oDocument.defaultView||this.oDocument.parentWindow,this.id=this.$inputor[0].id||e(),this.setting=null,this.query=null,this.pos=0,this.cur_rect=null,this.range=null,c.append(this.$el=b("<div id='atwho-ground-"+this.id+"'></div>")),this.model=new j(this),this.view=new k(this)}var e,f;return f=0,e=function(){return f+=1},d.prototype.init=function(a){return this.setting=b.extend({},this.setting||b.fn.atwho["default"],a),this.view.init(),this.model.reload(this.setting.data)},d.prototype.call_default=function(){var c,d,e;e=arguments[0],c=2<=arguments.length?a.call(arguments,1):[];try{return h[e].apply(this,c)}catch(f){return d=f,b.error(""+d+" Or maybe At.js doesn't have function "+e)}},d.prototype.trigger=function(a,b){var c,d;return b.push(this),c=this.get_opt("alias"),d=c?""+a+"-"+c+".atwho":""+a+".atwho",this.$inputor.trigger(d,b)},d.prototype.callbacks=function(a){return this.get_opt("callbacks")[a]||h[a]},d.prototype.get_opt=function(a){var b;try{return this.setting[a]}catch(c){return b=c,null}},d.prototype.content=function(){return this.$inputor.is("textarea, input")?this.$inputor.val():this.$inputor.text()},d.prototype.catch_query=function(){var a,b,c,d,e,f;return b=this.content(),a=this.$inputor.caret("pos"),f=b.slice(0,a),d=this.callbacks("matcher").call(this,this.at,f,this.get_opt("start_with_space")),"string"==typeof d&&d.length<=this.get_opt("max_len",20)?(e=a-d.length,c=e+d.length,this.pos=e,d={text:d.toLowerCase(),head_pos:e,end_pos:c},this.trigger("matched",[this.at,d.text])):this.view.hide(),this.query=d},d.prototype.rect=function(){var a,b;if(a=this.$inputor.caret("offset",this.pos-1))return"true"===this.$inputor.attr("contentEditable")&&(a=this.cur_rect||(this.cur_rect=a)||a),b=document.selection?0:2,{left:a.left,top:a.top,bottom:a.top+a.height+b}},d.prototype.reset_rect=function(){return"true"===this.$inputor.attr("contentEditable")?this.cur_rect=null:void 0},d.prototype.mark_range=function(){return"true"===this.$inputor.attr("contentEditable")&&(this.oWindow.getSelection&&(this.range=this.oWindow.getSelection().getRangeAt(0)),this.oDocument.selection)?this.ie8_range=this.oDocument.selection.createRange():void 0},d.prototype.insert_content_for=function(a){var c,d,e;return d=a.data("value"),e=this.get_opt("insert_tpl"),this.$inputor.is("textarea, input")||!e?d:(c=b.extend({},a.data("item-data"),{"atwho-data-value":d,"atwho-at":this.at}),this.callbacks("tpl_eval").call(this,e,c))},d.prototype.insert=function(a,c){var d,e,f,g,h,i,j,k,l,m,n;return d=this.$inputor,"true"===d.attr("contentEditable")&&(f="atwho-view-flag atwho-view-flag-"+(this.get_opt("alias")||this.at),g=""+a+"<span contenteditable='false'>&nbsp;<span>",h="<span contenteditable='false' class='"+f+"'>"+g+"</span>",e=b(h,this.oDocument).data("atwho-data-item",c.data("item-data")),this.oDocument.selection&&(e=b("<span contenteditable='true'></span>",this.oDocument).html(e))),d.is("textarea, input")?(a=""+a,l=d.val(),m=l.slice(0,Math.max(this.query.head_pos-this.at.length,0)),n=""+m+a+" "+l.slice(this.query.end_pos||0),d.val(n),d.caret("pos",m.length+a.length+1)):(j=this.range)?(i=j.startOffset-(this.query.end_pos-this.query.head_pos)-this.at.length,j.setStart(j.endContainer,Math.max(i,0)),j.setEnd(j.endContainer,j.endOffset),j.deleteContents(),j.insertNode(e[0]),j.collapse(!1),k=this.oWindow.getSelection(),k.removeAllRanges(),k.addRange(j)):(j=this.ie8_range)&&(j.moveStart("character",this.query.end_pos-this.query.head_pos-this.at.length),j.pasteHTML(g),j.collapse(!1),j.select()),d.focus(),d.change()},d.prototype.render_view=function(a){var b;return b=this.get_opt("search_key"),a=this.callbacks("sorter").call(this,this.query.text,a.slice(0,1001),b),this.view.render(a.slice(0,this.get_opt("limit")))},d.prototype.look_up=function(){var a,c;if(a=this.catch_query())return c=function(a){return a&&a.length>0?this.render_view(a):this.view.hide()},this.model.query(a.text,b.proxy(c,this)),a},d}(),j=function(){function a(a){this.context=a,this.at=this.context.at,this.storage=this.context.$inputor}return a.prototype.saved=function(){return this.fetch()>0},a.prototype.query=function(a,b){var c,d,e;return c=this.fetch(),d=this.context.get_opt("search_key"),c=this.context.callbacks("filter").call(this.context,a,c,d)||[],e=this.context.callbacks("remote_filter"),c.length>0||!e&&0===c.length?b(c):e.call(this.context,a,b)},a.prototype.fetch=function(){return this.storage.data(this.at)||[]},a.prototype.save=function(a){return this.storage.data(this.at,this.context.callbacks("before_save").call(this.context,a||[]))},a.prototype.load=function(a){return!this.saved()&&a?this._load(a):void 0},a.prototype.reload=function(a){return this._load(a)},a.prototype._load=function(a){return"string"==typeof a?b.ajax(a,{dataType:"json"}).done(function(a){return function(b){return a.save(b)}}(this)):this.save(a)},a}(),k=function(){function a(a){this.context=a,this.$el=b("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>"),this.timeout_id=null,this.context.$el.append(this.$el),this.bind_event()}return a.prototype.init=function(){var a;return a=this.context.get_opt("alias")||this.context.at.charCodeAt(0),this.$el.attr({id:"at-view-"+a})},a.prototype.bind_event=function(){var a;return a=this.$el.find("ul"),a.on("mouseenter.atwho-view","li",function(c){return a.find(".cur").removeClass("cur"),b(c.currentTarget).addClass("cur")}).on("click",function(a){return function(b){return a.choose(),b.preventDefault()}}(this))},a.prototype.visible=function(){return this.$el.is(":visible")},a.prototype.choose=function(){var a,b;return a=this.$el.find(".cur"),b=this.context.insert_content_for(a),this.context.insert(this.context.callbacks("before_insert").call(this.context,b,a),a),this.context.trigger("inserted",[a]),this.hide()},a.prototype.reposition=function(a){var c;return a.bottom+this.$el.height()-b(window).scrollTop()>b(window).height()&&(a.bottom=a.top-this.$el.height()),c={left:a.left,top:a.bottom},this.$el.offset(c),this.context.trigger("reposition",[c])},a.prototype.next=function(){var a,b;return a=this.$el.find(".cur").removeClass("cur"),b=a.next(),b.length||(b=this.$el.find("li:first")),b.addClass("cur")},a.prototype.prev=function(){var a,b;return a=this.$el.find(".cur").removeClass("cur"),b=a.prev(),b.length||(b=this.$el.find("li:last")),b.addClass("cur")},a.prototype.show=function(){var a;return this.context.mark_range(),this.visible()||this.$el.show(),(a=this.context.rect())?this.reposition(a):void 0},a.prototype.hide=function(a){var b;return isNaN(a&&this.visible())?(this.context.reset_rect(),this.$el.hide()):(b=function(a){return function(){return a.hide()}}(this),clearTimeout(this.timeout_id),this.timeout_id=setTimeout(b,a))},a.prototype.render=function(a){var c,d,e,f,g,h,i;if(!(b.isArray(a)&&a.length>0))return void this.hide();for(this.$el.find("ul").empty(),d=this.$el.find("ul"),g=this.context.get_opt("tpl"),h=0,i=a.length;i>h;h++)e=a[h],e=b.extend({},e,{"atwho-at":this.context.at}),f=this.context.callbacks("tpl_eval").call(this.context,g,e),c=b(this.context.callbacks("highlighter").call(this.context,f,this.context.query.text)),c.data("item-data",e),d.append(c);return this.show(),d.find("li:first").addClass("cur")},a}(),i={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13},h={before_save:function(a){var c,d,e,f;if(!b.isArray(a))return a;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(b.isPlainObject(c)?c:{name:c});return f},matcher:function(a,b,c){var d,e;return a=a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),c&&(a="(?:^|\\s)"+a),e=new RegExp(a+"([A-Za-z0-9_+-]*)$|"+a+"([^\\x00-\\xff]*)$","gi"),d=e.exec(b),d?d[2]||d[1]:null},filter:function(a,b,c){var d,e,f,g;for(g=[],e=0,f=b.length;f>e;e++)d=b[e],~d[c].toLowerCase().indexOf(a)&&g.push(d);return g},remote_filter:null,sorter:function(a,b,c){var d,e,f,g;if(!a)return b;for(g=[],e=0,f=b.length;f>e;e++)d=b[e],d.atwho_order=d[c].toLowerCase().indexOf(a),d.atwho_order>-1&&g.push(d);return g.sort(function(a,b){return a.atwho_order-b.atwho_order})},tpl_eval:function(a,b){var c;try{return a.replace(/\$\{([^\}]*)\}/g,function(a,c){return b[c]})}catch(d){return c=d,""}},highlighter:function(a,b){var c;return b?(c=new RegExp(">\\s*(\\w*)("+b.replace("+","\\+")+")(\\w*)\\s*<","ig"),a.replace(c,function(a,b,c,d){return"> "+b+"<strong>"+c+"</strong>"+d+" <"})):a},before_insert:function(a){return a}},d={load:function(a,b){var c;return(c=this.controller(a))?c.model.load(b):void 0},getInsertedItemsWithIDs:function(a){var c,d,e;return(c=this.controller(a))?(a&&(a="-"+(c.get_opt("alias")||c.at)),d=[],e=b.map(this.$inputor.find("span.atwho-view-flag"+(a||"")),function(a){var c;return c=b(a).data("atwho-data-item"),d.indexOf(c.id)>-1?void 0:(c.id&&(d.push=c.id),c)}),[d,e]):[null,null]},getInsertedItems:function(a){return d.getInsertedItemsWithIDs.apply(this,[a])[1]},getInsertedIDs:function(a){return d.getInsertedItemsWithIDs.apply(this,[a])[0]},run:function(){return this.dispatch()}},f={init:function(a){var c,d;return d=(c=b(this)).data("atwho"),d||c.data("atwho",d=new e(this)),d.reg(a.at,a),this}},c=b("<div id='atwho-container'></div>"),b.fn.atwho=function(a){var e,g;return g=arguments,b("body").append(c),e=null,this.filter("textarea, input, [contenteditable=true]").each(function(){var c;return"object"!=typeof a&&a?d[a]?(c=b(this).data("atwho"))?e=d[a].apply(c,Array.prototype.slice.call(g,1)):void 0:b.error("Method "+a+" does not exist on jQuery.caret"):f.init.apply(this,g)}),e||this},b.fn.atwho["default"]={at:void 0,alias:void 0,data:null,tpl:"<li data-value='${atwho-at}${name}'>${name}</li>",insert_tpl:"<span>${atwho-data-value}</span>",callbacks:h,search_key:"name",start_with_space:!0,limit:5,max_len:20,display_timeout:300}})}).call(this);